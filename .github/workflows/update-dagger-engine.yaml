name: dagger
run-name: ${{ github.actor }} is testing with dagger 🗡️
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
jobs:
  Test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dagger Engine
        uses: dagger/dagger-for-github@8.0.0
        with:
          version: latest

      - name: list-modules
        id: list-modules
        run: |
          modules=$(find . -maxdepth 2 -mindepth 2 -type f -name dagger.json -exec dirname {} \; | sed 's|^\./||' | paste -sd "," -)
          echo "modules=$modules" >> "$GITHUB_OUTPUT"

      - name: list-modules-with-tests
        id: list-modules-with-tests
        run: |
          test_modules=$(find . -maxdepth 3 -type f -path './*/tests/dagger.json' -exec dirname {} \; | sed 's|^\./||' | paste -sd "," -)
          echo "test_modules=$test_modules" >> "$GITHUB_OUTPUT"

      #these need to be loops of the modules, cant pass a list into develop
      - name: Update Dagger engine
        run: dagger develop -m ${{ steps.list-modules.outputs.modules }}

      - name: Update Dagger engine (tests)
        run: dagger develop -m ${{ steps.list-modules-with-tests.outputs.test_modules }}
